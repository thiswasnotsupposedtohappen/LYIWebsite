<!DOCTYPE html>
<html>

<head>
  <title>LightYear Industries</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@48,400,0,0&icon_names=shopping_cart" />
  <link rel="icon" type="image/x-icon" href="images/titleicon.png" />
</head>

<body class="Body">
  <div class="TopRibbon">    
    <a href=""><img src="images/LYI 500x380.png" style = "width: 250px; height: 100px; object-fit: cover;"></a>
    <div><a class="TopRibbonText" href="index.html">Home</a></div>
    <div><a class="TopRibbonText" href="shop.html">Shop</a></div>
    <div><a class="TopRibbonText" href="career.html">Career</a></div>
    <div><a class="TopRibbonText" href="contact.html">Contact Us</a></div>
    <div><a class="TopRibbonText" href="cart.html"><span class="material-symbols-outlined" style="width: 100px; font-size: 50px;">shopping_cart</span></a></div>
  </div>

  <button class = "shop-manufacturingconfig-button" onclick="OnClickLoadDXF()">LoadDXF</button>

  <input type="file" id="fileInput" style="padding-left: 50px;"></input><br>

  <div id = "viewer" style="height: 500px; margin-top: 50px; border-style: solid; border-width: 2px; border-color: black;">
    <canvas></canvas>
  </div>

  <div>    
    <br>DXF Output:<br>
  </div>
  <div class="consoleoutput">    
  </div>
  
</body>

<script src="wasm/LYIWebsite.js"></script>  
<script>  
class Point
{
  constructor()
  {
    this.x=undefined;
    this.y=undefined;
  }
};
class Line
{
  constructor()
  {
    this.p0=undefined;
    this.p1=undefined;
  }
};
var drawing = undefined;
var drawinglength = undefined;

var zoom = 1;
var buttonleftmousedown = false;
var mousex = 0, mousey = 0;
var viewer = document.getElementById("viewer");
var canvas = document.querySelector("canvas");
canvas.width = viewer.clientWidth;
canvas.height = viewer.clientHeight;
var ctx = canvas.getContext("2d");
ctx.resetTransform();
ctx.translate(canvas.width/2,canvas.height/2);
ctx.scale(1,-1);

ctx.strokeStyle = "red";
ctx.beginPath();
ctx.moveTo(0,0);
ctx.lineTo((canvas.width/2),0);
ctx.moveTo(0,0);
ctx.lineTo(0,(canvas.height/2));    
ctx.stroke();

Module.onRuntimeInitialized = function() 
{
  console.log("WASM Loaded");
};
addEventListener("resize", function() 
{
  canvas.width = viewer.clientWidth;
  canvas.height = viewer.clientHeight;
  DrawDXF();
});
canvas.addEventListener('wheel', function(event) 
{
  event.preventDefault();
  zoom -= event.deltaY/1000;
  if(zoom < 0.1)
    zoom = 0.1;
  DrawDXF();
});
canvas.addEventListener('mousedown', function(event) 
{
  if (event.button === 0) 
    buttonleftmousedown = true;
});
canvas.addEventListener('mouseup', function(event) 
{
  if (event.button === 0) 
    buttonleftmousedown = false;
});
canvas.addEventListener('mousemove', function(event) 
{
  if (buttonleftmousedown) 
  {
    mousex += event.movementX;
    mousey -= event.movementY;
    DrawDXF();
  }
});

console.log("System Ready");

function DrawDXF()
{
  ctx.clearRect(-canvas.width/2,-canvas.height/2,canvas.width,canvas.height);

  ctx.strokeStyle = "red";
  ctx.beginPath();
  ctx.moveTo(mousex,mousey);
  ctx.lineTo((canvas.width/2),mousey);
  ctx.moveTo(mousex,mousey);
  ctx.lineTo(mousex,(canvas.height/2));    
  ctx.stroke();

  ctx.strokeStyle = "blue";
  var toggle = 0
  for(var i=0;i<drawinglength;i++)
  {
    if(toggle == 0)
    {
      ctx.strokeStyle = "blue";
      toggle = 1;
    }
    else
    {
      ctx.strokeStyle = "green";
      toggle = 0;
    }
    ctx.beginPath();
    ctx.moveTo((drawing[i].p0.x * zoom + mousex),(drawing[i].p0.y * zoom + mousey));
    ctx.lineTo((drawing[i].p1.x * zoom + mousex),(drawing[i].p1.y * zoom + mousey));   
    ctx.stroke();
  }
} 

function OnClickLoadDXF() 
{
  var fileInput = document.getElementById('fileInput');
  var file = fileInput.files[0];
  if (file) 
  {
    var reader = new FileReader();
    reader.onload = function(e) 
    {
      var stringdata = e.target.result;
      var data = new Uint8Array(new TextEncoder().encode(stringdata));
      var memory = _malloc(data.length);
      HEAPU8.set(data, memory);

      console.log("return = " + _LoadDXF(memory, data.length));
      _free(memory);

      var address = _GETdrawing();
      drawinglength =  _GETdrawinglength();
      drawing = new Array(drawinglength);
      for(var i=0;i<drawinglength;i++)
      {
        drawing[i] = new Line;
        drawing[i].p0 = new Point;
        drawing[i].p1 = new Point;
        drawing[i].p0.x = HEAPF64[address/8 + 0];
        drawing[i].p0.y = HEAPF64[address/8 + 1];
        drawing[i].p1.x = HEAPF64[address/8 + 2];
        drawing[i].p1.y = HEAPF64[address/8 + 3];
        address += 32;
      }
      DrawDXF();
    };
    reader.readAsText(file);
  } 
  else 
  {
    console.log("No file selected");
  }
}
</script>

</html>